<script>
	import Codemirror from "./codemirror/Codemirror.html"
	import AnsiUp from "ansi_up"

	const ansiup = new AnsiUp()

	let text, stdout, stderr, payload

	function sendText(){
		fetch('/python', {
            method: 'POST',
            headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json',
				'x-csrf-token': window.csrfToken
			},
            body: JSON.stringify({ command: text })
        })
        .then(resp => resp.json())
        .then(s => {
      console.log(s)
			stdout = s.stdout //.replace(new RegExp('\n', 'g'), '')
			stderr = s.stderr
      payload = s.payload.map(s => 
        s//.replace(new RegExp('\n', 'g'), '')
      )
		})
	}

	function on_change(cm){
		text = cm.getValue()
	}

</script>

<style>
	.stdout {
		font-family: mono;
  }
</style>

<div>
	<div>
    <Codemirror mode="python" on_change={on_change}></Codemirror>
    {#if stdout}
      <div class="stdout">
        {@html stdout }
      </div>
    {/if}
    {#if stderr}
      <div class="stderr">
        {@html stderr }
      </div>
    {/if}
    {#if payload}
      <div class="payload">
        {#each payload as load}
          <pre>
            {@html ansiup.ansi_to_html(load) }
          </pre>
        {/each}
      </div>
    {/if}
	</div>
	<button on:click={sendText}>Send me</button>
</div>
